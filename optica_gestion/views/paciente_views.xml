<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Secuencia para número de ficha -->
        <record id="sequence_paciente_ficha" model="ir.sequence">
            <field name="name">Ficha de Paciente</field>
            <field name="code">optica.paciente.ficha</field>
            <field name="prefix">F-</field>
            <field name="padding">5</field>
        </record>

        <!-- Vista de formulario de paciente -->
        <record id="view_paciente_form" model="ir.ui.view">
            <field name="name">optica.paciente.form</field>
            <field name="model">optica.paciente</field>
            <field name="arch" type="xml">
                <form string="Ficha de Paciente">
                    <header>
                        <button name="action_nueva_cita" string="Nueva Cita" type="object" class="oe_highlight"/>
                        <button name="action_nueva_consulta" string="Registrar Consulta" type="object" class="oe_highlight"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_ver_consultas" type="object" class="oe_stat_button" icon="fa-stethoscope">
                                <field name="consulta_count" widget="statinfo" string="Consultas"/>
                            </button>
                            <button name="action_ver_citas" type="object" class="oe_stat_button" icon="fa-calendar">
                                <field name="cita_count" widget="statinfo" string="Citas"/>
                            </button>
                        </div>
                        
                        <!-- Encabezado con Ficha No. y Fecha -->
                        <div class="oe_title">
                            <h1>
                                <field name="name" placeholder="Nombre del Paciente"/>
                            </h1>
                            <div class="d-flex gap-4 mt-2">
                                <span class="text-muted">
                                    <strong>Ficha No.:</strong> <field name="ficha_numero" class="oe_inline"/>
                                </span>
                                <span class="text-muted">
                                    <strong>Fecha Registro:</strong> <field name="fecha_registro" class="oe_inline" widget="date"/>
                                </span>
                                <span class="text-muted" invisible="not ultima_consulta_fecha">
                                    <strong>Última Consulta:</strong> <field name="ultima_consulta_fecha" class="oe_inline"/>
                                </span>
                            </div>
                        </div>
                        
                        <!-- DATOS PERSONALES -->
                        <group>
                            <group string="Datos Personales">
                                <field name="fecha_nacimiento"/>
                                <field name="edad"/>
                                <field name="ocupacion"/>
                                <field name="telefono" widget="phone"/>
                                <field name="email" widget="email"/>
                            </group>
                            <group string="Contacto">
                                <field name="direccion"/>
                                <field name="referencia" placeholder="¿Cómo se enteró de nosotros?"/>
                            </group>
                        </group>
                        
                        <notebook>
                            <!-- HISTORIAL DE CONSULTAS (lo más importante) -->
                            <page string="Historial de Consultas" name="historial_consultas">
                                <field name="consulta_ids" readonly="1">
                                    <list string="Historial de Exámenes" default_order="fecha desc">
                                        <field name="fecha" string="Fecha"/>
                                        <field name="optometrista_id" string="Optometrista"/>
                                        <field name="av_sl_od" string="AV/SL OD"/>
                                        <field name="av_sl_oi" string="AV/SL OI"/>
                                        <field name="rx_od_esfera" string="RX OD Esf"/>
                                        <field name="rx_od_cilindro" string="RX OD Cil"/>
                                        <field name="rx_oi_esfera" string="RX OI Esf"/>
                                        <field name="rx_oi_cilindro" string="RX OI Cil"/>
                                        <field name="tipo_lente" string="Tipo Lente"/>
                                        <field name="diagnostico" string="Diagnóstico"/>
                                    </list>
                                </field>
                                <group invisible="consulta_count > 0">
                                    <div class="text-muted">
                                        <p>Este paciente no tiene consultas registradas.</p>
                                        <p>Haga clic en "Registrar Consulta" para agregar un examen visual.</p>
                                    </div>
                                </group>
                            </page>
                            
                            <!-- FICHA DE EXAMEN (Datos de entrada) -->
                            <page string="Ficha de Examen" name="ficha_examen">
                                <!-- Preguntas principales -->
                                <group string="Historial del Paciente">
                                    <group>
                                        <field name="evaluacion_visual_previa" widget="radio" options="{'horizontal': true}"/>
                                        <field name="fecha_ultima_evaluacion" invisible="evaluacion_visual_previa != 'si'"/>
                                        <field name="padece_enfermedad" widget="radio" options="{'horizontal': true}"/>
                                        <field name="enfermedades" invisible="padece_enfermedad != 'si'" placeholder="Especificar enfermedades..."/>
                                        <field name="usa_computadora" widget="radio" options="{'horizontal': true}"/>
                                    </group>
                                    <group>
                                        <field name="antecedentes_familiares" widget="radio" options="{'horizontal': true}"/>
                                        <field name="antecedentes_familiares_detalle" invisible="antecedentes_familiares != 'si'" placeholder="Glaucoma, cataratas, etc..."/>
                                        <field name="usa_lentes" widget="radio"/>
                                        <field name="tipo_lentes_previos" invisible="usa_lentes == 'no'" placeholder="Tipo de lentes usados..."/>
                                    </group>
                                </group>
                                
                                <!-- Condiciones médicas -->
                                <group string="Condiciones Médicas">
                                    <group>
                                        <field name="embarazo" widget="radio" options="{'horizontal': true}"/>
                                        <field name="diabetes"/>
                                    </group>
                                    <group>
                                        <field name="presion_arterial"/>
                                        <field name="cirugia_previa"/>
                                    </group>
                                </group>
                                
                                <!-- SÍNTOMAS -->
                                <group string="Síntomas">
                                    <group>
                                        <field name="sintoma_cefalea"/>
                                        <field name="sintoma_ardor"/>
                                        <field name="sintoma_dolor"/>
                                        <field name="sintoma_ojo_rojo"/>
                                        <field name="sintoma_fotofobia"/>
                                        <field name="sintoma_glaucoma"/>
                                    </group>
                                    <group>
                                        <field name="sintoma_vision_borrosa"/>
                                        <field name="sintoma_secreciones"/>
                                        <field name="sintoma_cansancio"/>
                                        <field name="sintoma_moscas_volantes"/>
                                        <field name="sintoma_otros"/>
                                        <field name="sintoma_otros_descripcion" invisible="not sintoma_otros"/>
                                    </group>
                                </group>
                                
                                <!-- Notas -->
                                <group string="Información Adicional">
                                    <group>
                                        <field name="alergias" placeholder="Alergias conocidas..."/>
                                    </group>
                                    <group>
                                        <field name="notas_medicas" placeholder="Notas médicas adicionales..."/>
                                    </group>
                                </group>
                            </page>
                            
                            <!-- CITAS -->
                            <page string="Citas" name="citas">
                                <field name="cita_ids" readonly="1">
                                    <list>
                                        <field name="fecha"/>
                                        <field name="hora_inicio" widget="float_time"/>
                                        <field name="optometrista_id"/>
                                        <field name="motivo"/>
                                        <field name="state" widget="badge"/>
                                    </list>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>

        <!-- Vista de lista de pacientes -->
        <record id="view_paciente_list" model="ir.ui.view">
            <field name="name">optica.paciente.list</field>
            <field name="model">optica.paciente</field>
            <field name="arch" type="xml">
                <list string="Pacientes">
                    <field name="ficha_numero"/>
                    <field name="name"/>
                    <field name="edad"/>
                    <field name="telefono"/>
                    <field name="ocupacion" optional="hide"/>
                    <field name="ultima_consulta_fecha" string="Última Consulta"/>
                    <field name="consulta_count" string="Consultas"/>
                </list>
            </field>
        </record>

        <!-- Vista de búsqueda -->
        <record id="view_paciente_search" model="ir.ui.view">
            <field name="name">optica.paciente.search</field>
            <field name="model">optica.paciente</field>
            <field name="arch" type="xml">
                <search string="Buscar Paciente">
                    <field name="name"/>
                    <field name="ficha_numero"/>
                    <field name="telefono"/>
                    <separator/>
                    <filter string="Usa Lentes" name="usa_lentes" domain="[('usa_lentes', '!=', 'no')]"/>
                    <filter string="Con Diabetes" name="diabetes" domain="[('diabetes', '=', True)]"/>
                </search>
            </field>
        </record>

        <!-- Vista kanban de pacientes -->
        <record id="view_paciente_kanban" model="ir.ui.view">
            <field name="name">optica.paciente.kanban</field>
            <field name="model">optica.paciente</field>
            <field name="arch" type="xml">
                <kanban>
                    <field name="name"/>
                    <field name="ficha_numero"/>
                    <field name="edad"/>
                    <field name="telefono"/>
                    <field name="consulta_count"/>
                    <templates>
                        <t t-name="card">
                            <div>
                                <div class="text-muted small"><field name="ficha_numero"/></div>
                                <strong><field name="name"/></strong>
                                <div>Edad: <field name="edad"/> años</div>
                                <div><field name="telefono" widget="phone"/></div>
                                <div>Consultas: <field name="consulta_count"/></div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Acción de ventana -->
        <record id="action_paciente" model="ir.actions.act_window">
            <field name="name">Pacientes</field>
            <field name="res_model">optica.paciente</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Registrar un nuevo paciente
                </p>
            </field>
        </record>
    </data>
</odoo>
